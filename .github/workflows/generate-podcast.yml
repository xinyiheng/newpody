name: Generate Podcast

on:
  schedule:
    - cron: '0 21-22 * * *'  # åœ¨ UTC 22:00 å’Œ 23:00 è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main  # åªåœ¨ä¸»åˆ†æ”¯ä¸Šè§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:         
      contents: write    
      issues: write     # æ·»åŠ åˆ›å»º issues çš„æƒé™
    
    steps:
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        ref: gh-pages
        path: gh-pages
        
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        path: main
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # åªç¼“å­˜ pip åŒ…
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('main/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd main
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install httpx ormsgpack pydantic

    - name: Generate podcast
      id: generate
      env:
        API_KEY: ${{ secrets.API_KEY }}
        FISH_API_KEY: ${{ secrets.FISH_API_KEY }}
      run: |
        cd main
        python scripts/generate_podcast.py

    # æ·»åŠ æäº¤ç¼“å­˜æ–‡ä»¶çš„æ­¥éª¤
    - name: Commit cache file
      if: steps.generate.outcome == 'success'
      run: |
        cd main
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add article_cache.json
        git commit -m "Update article cache" || echo "No changes to commit"
        git push origin main || echo "No changes to push"

    - name: Deploy to GitHub Pages
      run: |
        # å¤åˆ¶ç”Ÿæˆçš„æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯
        echo "å¤åˆ¶æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯..."
        cp -r main/web/public/podcasts/* gh-pages/podcasts/
        cp main/web/public/podcast_index.json gh-pages/
        
        # æäº¤æ›´æ”¹
        cd gh-pages
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update podcast content" || echo "No changes to commit"
        git push origin gh-pages || echo "No changes to push"

    - name: Update index.html to display highlights
      run: |
        echo "æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜..."
        cd gh-pages
        
        # ç¡®ä¿ index.html ä¸­æœ‰æ˜¾ç¤ºå‰¯æ ‡é¢˜çš„ä»£ç 
        if ! grep -q "podcast.highlight" index.html; then
          # åœ¨æ ‡é¢˜åæ·»åŠ å‰¯æ ‡é¢˜æ˜¾ç¤º
          sed -i 's/<h2 class="text-xl font-semibold"><\/h2>/<h2 class="text-xl font-semibold"><\/h2>\n                    <p class="text-gray-600 italic mt-1 text-sm highlight-text"><\/p>/' index.html
          
          # æ·»åŠ è®¾ç½®å‰¯æ ‡é¢˜çš„ä»£ç 
          sed -i 's/clone.querySelector("h2").textContent = podcast.title;/clone.querySelector("h2").textContent = podcast.title;\n                    clone.querySelector(".highlight-text").textContent = podcast.highlight || "æ¢ç´¢å‡ºç‰ˆè¡Œä¸šçš„æœ€æ–°åŠ¨æ€";/' index.html
          
          echo "å·²æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜"
          
          # æäº¤æ›´æ”¹
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "Add highlight display to index.html" || echo "No changes to commit"
          git push origin gh-pages || echo "No changes to push"
        else
          echo "index.html å·²åŒ…å«å‰¯æ ‡é¢˜æ˜¾ç¤ºä»£ç ï¼Œæ— éœ€æ›´æ–°"
        fi

    - name: Send notification on failure
      if: steps.generate.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast generation failed',
            body: `Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
          })
    
    - name: Check files before deploy
      run: |
        echo "Checking files in public directory..."
        cd main/web/public
        ls -la
        echo "Checking podcasts directory..."
        ls -la podcasts || echo "podcasts directory not found"
        echo "Checking latest podcast..."
        ls -la podcasts/$(ls -t podcasts | head -n1) || echo "No podcasts found"
        
    # æ·»åŠ éƒ¨ç½²åˆ° Zeabur çš„æ­¥éª¤
    - name: Setup Node.js for Zeabur CLI
      if: steps.generate.outcome == 'success'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Deploy to Zeabur
      if: steps.generate.outcome == 'success'
      id: zeabur_deploy
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
        ZEABUR_SERVICE_ID: ${{ secrets.ZEABUR_SERVICE_ID }}
      run: |
        # å®‰è£… Zeabur CLI
        echo "Installing Zeabur CLI..."
        npm install -g @zeabur/cli
        
        # æ£€æŸ¥ç‰ˆæœ¬
        echo "Checking Zeabur CLI version:"
        zeabur version
        
        # éªŒè¯ gh-pages ç›®å½•
        if [ ! -d "gh-pages" ]; then
          echo "Error: gh-pages directory not found!"
          exit 1
        fi
        
        # æ˜¾ç¤ºå°†è¦éƒ¨ç½²çš„æ–‡ä»¶
        echo "Files to be deployed to Zeabur:"
        ls -la gh-pages
        
        echo "Deploying to Zeabur..."
        cd gh-pages
        
        # è®¾ç½®æ›´é«˜çš„è¶…æ—¶å€¼
        export HTTP_TIMEOUT=900       # 15åˆ†é’Ÿè¶…æ—¶
        export HTTP_RETRY=10          # æœ€å¤šé‡è¯•10æ¬¡
        export HTTP_RETRY_WAIT=30     # åˆå§‹ç­‰å¾…30ç§’
        export HTTP_MAX_RETRY_WAIT=300 # æœ€å¤§ç­‰å¾…5åˆ†é’Ÿ
        
        # å°è¯•åŠ é€Ÿè¿æ¥ (å¯é€‰è®¾ç½®)
        export NODE_OPTIONS=--dns-result-order=ipv4first  # ä¼˜å…ˆä½¿ç”¨IPv4
        
        # è¯Šæ–­ç½‘ç»œè¿æ¥
        echo "Diagnosing network connection to Zeabur..."
        curl -v --connect-timeout 30 https://gateway.zeabur.com || true
        
        # æ˜¾ç¤ºå½“å‰IP (å¸®åŠ©è¯Šæ–­æ½œåœ¨çš„IPé™åˆ¶)
        echo "Current IP address:"
        curl -s https://api.ipify.org || true
        
        # ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥è®¾ç½®é¡¹ç›®ä¸Šä¸‹æ–‡
        echo "Setting project context with exponential backoff..."
        MAX_RETRY=10
        RETRY_COUNT=0
        WAIT_TIME=10
        
        while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
          RETRY_COUNT=$((RETRY_COUNT+1))
          echo "Setting project context, attempt $RETRY_COUNT of $MAX_RETRY (waiting ${WAIT_TIME}s before timeout)"
          
          if timeout ${WAIT_TIME}s zeabur context set project --id "${{ secrets.ZEABUR_PROJECT_ID }}" -i=false; then
            echo "Project context set successfully!"
            break
          else
            # æŒ‡æ•°é€€é¿ï¼šæ¯æ¬¡å¤±è´¥åç­‰å¾…æ—¶é—´ç¿»å€ï¼Œä½†ä¸è¶…è¿‡5åˆ†é’Ÿ
            echo "Failed to set project context, retrying with exponential backoff..."
            sleep $WAIT_TIME
            WAIT_TIME=$((WAIT_TIME * 2))
            [ $WAIT_TIME -gt 300 ] && WAIT_TIME=300
          fi
          
          if [ $RETRY_COUNT -eq $MAX_RETRY ]; then
            echo "All attempts to set project context failed."
            echo "Warning: Failed to set context, will try deployment anyway"
          fi
        done
        
        # ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥è¿›è¡Œéƒ¨ç½² - æ›´æ–°åˆ°ç°æœ‰æœåŠ¡è€Œä¸æ˜¯åˆ›å»ºæ–°æœåŠ¡
        echo "Deploying to existing service with exponential backoff strategy..."
        DEPLOY_RETRY=8
        DEPLOY_COUNT=0
        DEPLOY_WAIT=15
        
        while [ $DEPLOY_COUNT -lt $DEPLOY_RETRY ]; do
          DEPLOY_COUNT=$((DEPLOY_COUNT+1))
          echo "Deployment attempt $DEPLOY_COUNT of $DEPLOY_RETRY (timeout: ${DEPLOY_WAIT}s)"
          
          # å°è¯•å¤šç§éƒ¨ç½²æ–¹å¼ - ä½¿ç”¨æœåŠ¡IDç›´æ¥éƒ¨ç½²
          echo "Attempting to deploy using service ID..."
          if timeout ${DEPLOY_WAIT}s zeabur deploy --service-id "${ZEABUR_SERVICE_ID}" -i=false; then
            echo "Deployment succeeded using service ID!"
            break
          fi
          
          # å¦‚æœä½¿ç”¨æœåŠ¡IDå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡åç§° "public" è¿›è¡Œæ›´æ–°
          echo "Attempting to deploy using service name 'public'..."
          if timeout ${DEPLOY_WAIT}s zeabur deploy --name "public" --update -i=false; then
            echo "Deployment succeeded using service name 'public'!"
            break
          fi
          
          # å¦‚æœä½¿ç”¨æœåŠ¡IDå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä¹‹å‰çš„æœåŠ¡åç§°(å…¼å®¹æ€§)
          echo "Attempting to deploy using service name 'podcast-static-site'..."
          if timeout ${DEPLOY_WAIT}s zeabur deploy --name "podcast-static-site" --update -i=false; then
            echo "Deployment succeeded using service name 'podcast-static-site'!"
            break
          fi
          
          # å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•åœ¨æ²¡æœ‰æ ‡å¿—çš„æƒ…å†µä¸‹éƒ¨ç½²
          echo "Attempting to deploy with no specific flags..."
          if timeout ${DEPLOY_WAIT}s zeabur deploy -i=false; then
            echo "Deployment succeeded with no specific flags!"
            break
          else
            # æŒ‡æ•°é€€é¿ï¼šç­‰å¾…æ—¶é—´ç¿»å€ï¼Œä½†ä¸è¶…è¿‡5åˆ†é’Ÿ
            echo "Deployment failed, retrying with exponential backoff..."
            sleep $DEPLOY_WAIT
            DEPLOY_WAIT=$((DEPLOY_WAIT * 2))
            [ $DEPLOY_WAIT -gt 300 ] && DEPLOY_WAIT=300
            
            # ç¡®ä¿é¡¹ç›®ä¸Šä¸‹æ–‡ä»ç„¶æœ‰æ•ˆ
            echo "Re-checking project context..."
            zeabur context set project --id "${{ secrets.ZEABUR_PROJECT_ID }}" -i=false || true
          fi
          
          if [ $DEPLOY_COUNT -eq $DEPLOY_RETRY ]; then
            echo "All deployment attempts failed."
            
            # æœ€åå°è¯•å‘é€ç®€å•çš„ HTTP POST è¯·æ±‚è¿›è¡Œéƒ¨ç½²
            echo "Attempting direct API deployment as last resort..."
            curl -v -X POST "https://gateway.zeabur.com/api/v1/services/${ZEABUR_SERVICE_ID}/redeploy" \
              -H "Authorization: Bearer ${ZEABUR_TOKEN}" \
              -H "Content-Type: application/json" || true
            
            # å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œåˆ™é€€å‡ºé”™è¯¯
            exit 1
          fi
        done
        
        echo "âœ… Deployment to Zeabur completed successfully"
      continue-on-error: true
    
    - name: Report Zeabur Deployment Status
      if: always() && steps.zeabur_deploy.outcome != 'skipped'
      run: |
        if [ "${{ steps.zeabur_deploy.outcome }}" == "success" ]; then
          echo "ğŸ‰ Zeabur deployment was successful!"
          echo "Your site should be available at your Zeabur domain shortly"
        else
          echo "âŒ Zeabur deployment failed. Please check the logs above for details."
          
          echo "Recommendations:"
          echo "1. æ£€æŸ¥æ‚¨çš„ ZEABUR_SERVICE_ID å¯†é’¥æ˜¯å¦å·²æ­£ç¡®è®¾ç½®"
          echo "2. è®¿é—® Zeabur æ§åˆ¶å°ï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€å¹¶å°è¯•æ‰‹åŠ¨æ›´æ–°"
          echo "3. å¦‚æœç½‘ç»œé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè€ƒè™‘ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š"
          echo "   - ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ GitHub Actions è¿è¡Œå™¨ï¼Œæ”¾ç½®åœ¨ä¸ Zeabur ç›¸åŒåŒºåŸŸ"
          echo "   - ä½¿ç”¨ç¬¬ä¸‰æ–¹ CD æœåŠ¡ï¼Œå¦‚ Netlify æˆ– Vercel"
        fi
