name: Generate Podcast

on:
  schedule:
    - cron: '0 21-22 * * *'  # åœ¨ UTC 22:00 å’Œ 23:00 è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main  # åªåœ¨ä¸»åˆ†æ”¯ä¸Šè§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:         
      contents: write    
      issues: write     # æ·»åŠ åˆ›å»º issues çš„æƒé™
    
    steps:
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        ref: gh-pages
        path: gh-pages
        
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        path: main
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # åªç¼“å­˜ pip åŒ…
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('main/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd main
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install httpx ormsgpack pydantic

    - name: Generate podcast
      id: generate
      env:
        API_KEY: ${{ secrets.API_KEY }}
        FISH_API_KEY: ${{ secrets.FISH_API_KEY }}
      run: |
        cd main
        python scripts/generate_podcast.py

    # æ·»åŠ æäº¤ç¼“å­˜æ–‡ä»¶çš„æ­¥éª¤
    - name: Commit cache file
      if: steps.generate.outcome == 'success'
      run: |
        cd main
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add article_cache.json
        git commit -m "Update article cache" || echo "No changes to commit"
        git push origin main || echo "No changes to push"

    - name: Deploy to GitHub Pages
      run: |
        # å¤åˆ¶ç”Ÿæˆçš„æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯
        echo "å¤åˆ¶æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯..."
        cp -r main/web/public/podcasts/* gh-pages/podcasts/
        cp main/web/public/podcast_index.json gh-pages/
        
        # æäº¤æ›´æ”¹
        cd gh-pages
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update podcast content" || echo "No changes to commit"
        git push origin gh-pages || echo "No changes to push"

    - name: Update index.html to display highlights
      run: |
        echo "æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜..."
        cd gh-pages
        
        # ç¡®ä¿ index.html ä¸­æœ‰æ˜¾ç¤ºå‰¯æ ‡é¢˜çš„ä»£ç 
        if ! grep -q "podcast.highlight" index.html; then
          # åœ¨æ ‡é¢˜åæ·»åŠ å‰¯æ ‡é¢˜æ˜¾ç¤º
          sed -i 's/<h2 class="text-xl font-semibold"><\/h2>/<h2 class="text-xl font-semibold"><\/h2>\n                    <p class="text-gray-600 italic mt-1 text-sm highlight-text"><\/p>/' index.html
          
          # æ·»åŠ è®¾ç½®å‰¯æ ‡é¢˜çš„ä»£ç 
          sed -i 's/clone.querySelector("h2").textContent = podcast.title;/clone.querySelector("h2").textContent = podcast.title;\n                    clone.querySelector(".highlight-text").textContent = podcast.highlight || "æ¢ç´¢å‡ºç‰ˆè¡Œä¸šçš„æœ€æ–°åŠ¨æ€";/' index.html
          
          echo "å·²æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜"
          
          # æäº¤æ›´æ”¹
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "Add highlight display to index.html" || echo "No changes to commit"
          git push origin gh-pages || echo "No changes to push"
        else
          echo "index.html å·²åŒ…å«å‰¯æ ‡é¢˜æ˜¾ç¤ºä»£ç ï¼Œæ— éœ€æ›´æ–°"
        fi

    - name: Send notification on failure
      if: steps.generate.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast generation failed',
            body: `Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
          })
    
    - name: Check files before deploy
      run: |
        echo "Checking files in public directory..."
        cd main/web/public
        ls -la
        echo "Checking podcasts directory..."
        ls -la podcasts || echo "podcasts directory not found"
        echo "Checking latest podcast..."
        ls -la podcasts/$(ls -t podcasts | head -n1) || echo "No podcasts found"
        
    # æ·»åŠ éƒ¨ç½²åˆ° Zeabur çš„æ­¥éª¤
    - name: Setup Node.js for Zeabur CLI
      if: steps.generate.outcome == 'success'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Deploy to Zeabur
      if: steps.generate.outcome == 'success'
      id: zeabur_deploy
      run: |
        # å®‰è£… Zeabur CLI
        echo "Installing Zeabur CLI..."
        npm install -g @zeabur/cli || { echo "Failed to install Zeabur CLI"; exit 1; }
        
        # éªŒè¯ gh-pages ç›®å½•
        if [ ! -d "gh-pages" ]; then
          echo "Error: gh-pages directory not found!"
          exit 1
        fi
        
        # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
        echo "Verifying required files in gh-pages directory..."
        if [ ! -f "gh-pages/index.html" ]; then
          echo "Warning: index.html not found in gh-pages directory!"
        fi
        
        if [ ! -d "gh-pages/podcasts" ]; then
          echo "Warning: podcasts directory not found in gh-pages!"
        fi
        
        # é…ç½®è®¤è¯
        echo "Authenticating with Zeabur..."
        if ! echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur login --token-stdin; then
          echo "Failed to authenticate with Zeabur"
          exit 1
        fi
        
        # æ˜¾ç¤ºå°†è¦éƒ¨ç½²çš„æ–‡ä»¶
        echo "Files to be deployed to Zeabur:"
        ls -la gh-pages
        echo "Content of podcasts directory:"
        ls -la gh-pages/podcasts || echo "No podcasts directory found"
        
        # éƒ¨ç½²åˆ° Zeabur
        echo "Deploying to Zeabur..."
        cd gh-pages
        
        # è®¾ç½®è¶…æ—¶ä¸º 5 åˆ†é’Ÿ
        timeout 300 zeabur deploy --project ${{ secrets.ZEABUR_PROJECT_ID }} --service static-site || {
          echo "Zeabur deployment failed or timed out after 5 minutes"
          exit 1
        }
        
        echo "âœ… Deployment to Zeabur completed successfully"
      continue-on-error: true
    
    - name: Report Zeabur Deployment Status
      if: always() && steps.zeabur_deploy.outcome != 'skipped'
      run: |
        if [ "${{ steps.zeabur_deploy.outcome }}" == "success" ]; then
          echo "ğŸ‰ Zeabur deployment was successful!"
          echo "Your site should be available at your Zeabur domain shortly"
        else
          echo "âŒ Zeabur deployment failed. Please check the logs above for details."
          echo "Common issues:"
          echo "1. Authentication problems - check your ZEABUR_TOKEN"
          echo "2. Project ID issues - verify your ZEABUR_PROJECT_ID"
          echo "3. Network timeouts - the deployment might still be processing"
        fi
