name: Generate Podcast

on:
  schedule:
    - cron: '0 22-23 * * *'  # 在 UTC 22:00 和 23:00 运行
  workflow_dispatch:      # 允许手动触发
  push:
    branches:
      - main  # 只在主分支上触发

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:         
      contents: write    
      issues: write     # 添加创建 issues 的权限
    
    steps:
    - uses: actions/checkout@v4  # 升级到 v4
      with:
        ref: gh-pages
        path: gh-pages
        
    - uses: actions/checkout@v4  # 升级到 v4
      with:
        path: main
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # 只缓存 pip 包
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('main/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r main/requirements.txt
    
    - name: Copy existing podcasts
      run: |
        if [ -d "gh-pages/podcasts" ]; then
          mkdir -p main/web/public/podcasts
          cp -r gh-pages/podcasts/* main/web/public/podcasts/
        fi
        if [ -f "gh-pages/podcast_index.json" ]; then
          cp gh-pages/podcast_index.json main/web/public/
        fi

    - name: Generate podcast
      id: generate
      run: |
        cd main
        pwd
        ls -la
        python scripts/generate_podcast.py
      env:
        API_KEY: ${{ secrets.API_KEY }}
        FISH_API_KEY: ${{ secrets.FISH_API_KEY }}
      continue-on-error: true

    # 添加提交缓存文件的步骤
    - name: Commit cache file
      if: steps.generate.outcome == 'success'
      run: |
        cd main
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add article_cache.json
        git commit -m "Update article cache" || echo "No changes to commit"
        git push origin main || echo "No changes to push"

    - name: Send notification on failure
      if: steps.generate.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast generation failed',
            body: `Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
          })
    
    - name: Check files before deploy
      run: |
        echo "Checking files in public directory..."
        cd main/web/public
        ls -la
        echo "Checking podcasts directory..."
        ls -la podcasts || echo "podcasts directory not found"
        echo "Checking latest podcast..."
        ls -la podcasts/$(ls -t podcasts | head -n1) || echo "No podcasts found"

    - name: Fix index.html in gh-pages
      run: |
        echo "修复 gh-pages 分支中的 index.html 文件..."
        cd gh-pages
        
        # 添加 fixPath 函数到 index.html
        sed -i '/const modal = document.getElementById/i \
            function fixPath(path) {\
                if (path && path.startsWith("./")) {\
                    return path.substring(2);\
                }\
                return path;\
            }' index.html
        
        # 修改音频源设置，使用 fixPath 函数
        sed -i 's/sourceElement.src = podcast.audio_path;/sourceElement.src = fixPath(podcast.audio_path);/' index.html
        
        # 修改文稿加载，使用 fixPath 函数
        sed -i '/const scriptPath = podcast.transcript_path;/c \            const scriptPath = fixPath(podcast.transcript_path);' index.html
        
        # 添加调试日志
        sed -i '/const scriptPath = fixPath/a \            console.log("尝试加载文稿路径:", scriptPath);' index.html
        
        echo "修复完成，准备提交更改..."
        
        # 提交更改
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add index.html
        git commit -m "Fix path handling in index.html" || echo "No changes to commit"
        git push origin gh-pages || echo "No changes to push"

    - name: Deploy to GitHub Pages
      if: steps.generate.outcome == 'success'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./main/web/public
        keep_files: true
    
    - name: Debug Info
      run: |
        echo "Current time: $(date)"
        echo "Current UTC time: $(date -u)"
        echo "GitHub event: ${{ github.event_name }}"
        echo "Trigger type: ${{ github.event.schedule || 'manual' }}"
        echo "Generation status: ${{ steps.generate.outcome }}"
