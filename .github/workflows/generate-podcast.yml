name: Generate Podcast

on:
  schedule:
    - cron: '0 21-22 * * *'  # åœ¨ UTC 22:00 å’Œ 23:00 è¿è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main  # åªåœ¨ä¸»åˆ†æ”¯ä¸Šè§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:         
      contents: write    
      issues: write     # æ·»åŠ åˆ›å»º issues çš„æƒé™
    
    steps:
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        ref: gh-pages
        path: gh-pages
        
    - uses: actions/checkout@v4  # å‡çº§åˆ° v4
      with:
        path: main
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    # åªç¼“å­˜ pip åŒ…
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('main/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd main
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install httpx ormsgpack pydantic

    - name: Generate podcast
      id: generate
      env:
        API_KEY: ${{ secrets.API_KEY }}
        FISH_API_KEY: ${{ secrets.FISH_API_KEY }}
      run: |
        cd main
        python scripts/generate_podcast.py

    # æ·»åŠ æäº¤ç¼“å­˜æ–‡ä»¶çš„æ­¥éª¤
    - name: Commit cache file
      if: steps.generate.outcome == 'success'
      run: |
        cd main
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add article_cache.json
        git commit -m "Update article cache" || echo "No changes to commit"
        git push origin main || echo "No changes to push"

    - name: Deploy to GitHub Pages
      run: |
        # å¤åˆ¶ç”Ÿæˆçš„æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯
        echo "å¤åˆ¶æ’­å®¢æ–‡ä»¶åˆ° gh-pages åˆ†æ”¯..."
        cp -r main/web/public/podcasts/* gh-pages/podcasts/
        cp main/web/public/podcast_index.json gh-pages/
        
        # æäº¤æ›´æ”¹
        cd gh-pages
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update podcast content" || echo "No changes to commit"
        git push origin gh-pages || echo "No changes to push"

    - name: Update index.html to display highlights
      run: |
        echo "æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜..."
        cd gh-pages
        
        # ç¡®ä¿ index.html ä¸­æœ‰æ˜¾ç¤ºå‰¯æ ‡é¢˜çš„ä»£ç 
        if ! grep -q "podcast.highlight" index.html; then
          # åœ¨æ ‡é¢˜åæ·»åŠ å‰¯æ ‡é¢˜æ˜¾ç¤º
          sed -i 's/<h2 class="text-xl font-semibold"><\/h2>/<h2 class="text-xl font-semibold"><\/h2>\n                    <p class="text-gray-600 italic mt-1 text-sm highlight-text"><\/p>/' index.html
          
          # æ·»åŠ è®¾ç½®å‰¯æ ‡é¢˜çš„ä»£ç 
          sed -i 's/clone.querySelector("h2").textContent = podcast.title;/clone.querySelector("h2").textContent = podcast.title;\n                    clone.querySelector(".highlight-text").textContent = podcast.highlight || "æ¢ç´¢å‡ºç‰ˆè¡Œä¸šçš„æœ€æ–°åŠ¨æ€";/' index.html
          
          echo "å·²æ›´æ–° index.html ä»¥æ˜¾ç¤ºå‰¯æ ‡é¢˜"
          
          # æäº¤æ›´æ”¹
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "Add highlight display to index.html" || echo "No changes to commit"
          git push origin gh-pages || echo "No changes to push"
        else
          echo "index.html å·²åŒ…å«å‰¯æ ‡é¢˜æ˜¾ç¤ºä»£ç ï¼Œæ— éœ€æ›´æ–°"
        fi

    - name: Send notification on failure
      if: steps.generate.outcome == 'failure'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Podcast generation failed',
            body: `Workflow run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
          })
    
    - name: Check files before deploy
      run: |
        echo "Checking files in public directory..."
        cd main/web/public
        ls -la
        echo "Checking podcasts directory..."
        ls -la podcasts || echo "podcasts directory not found"
        echo "Checking latest podcast..."
        ls -la podcasts/$(ls -t podcasts | head -n1) || echo "No podcasts found"
        
    # æ·»åŠ éƒ¨ç½²åˆ° Zeabur çš„æ­¥éª¤
    - name: Setup Node.js for Zeabur CLI
      if: steps.generate.outcome == 'success'
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Deploy to Zeabur
      if: steps.generate.outcome == 'success'
      id: zeabur_deploy
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
      run: |
        # å®‰è£… Zeabur CLI
        echo "Installing Zeabur CLI..."
        npm install -g @zeabur/cli
        
        # æ£€æŸ¥ç‰ˆæœ¬ï¼ˆæ ¹æ®å¸®åŠ©ä¿¡æ¯ä¿®æ­£å‘½ä»¤ï¼‰
        echo "Checking Zeabur CLI version:"
        zeabur version
        
        # éªŒè¯ gh-pages ç›®å½•
        if [ ! -d "gh-pages" ]; then
          echo "Error: gh-pages directory not found!"
          exit 1
        fi
        
        # æ˜¾ç¤ºå°†è¦éƒ¨ç½²çš„æ–‡ä»¶
        echo "Files to be deployed to Zeabur:"
        ls -la gh-pages
        
        echo "Deploying to Zeabur..."
        cd gh-pages
        
        # è®¾ç½®è¶…æ—¶æ—¶é—´å¢åŠ åˆ° 5 åˆ†é’Ÿï¼Œé˜²æ­¢è¿æ¥è¶…æ—¶é—®é¢˜
        echo "Setting HTTP_TIMEOUT=300"
        export HTTP_TIMEOUT=300
        
        # æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨
        echo "Listing projects (to verify connectivity and authentication):"
        zeabur project list -i=false || {
          echo "Failed to list projects. Authentication or connectivity issue."
          echo "Continuing with deployment anyway..."
        }
        
        # æ ¹æ®å¸®åŠ©ä¿¡æ¯ï¼Œä½¿ç”¨æ­£ç¡®çš„ deploy å‘½ä»¤å’Œå‚æ•°
        SERVICE_NAME="podcast-static-site"
        
        echo "Deploying with direct deploy command..."
        zeabur deploy --name "$SERVICE_NAME" --create -i=false || {
          echo "First method failed, trying service deploy..."
          
          # å°è¯•æœåŠ¡éƒ¨ç½²å‘½ä»¤
          zeabur service deploy -i=false || {
            echo "All deployment methods failed"
            exit 1
          }
        }
        
        echo "âœ… Deployment to Zeabur completed successfully"
      continue-on-error: true
    
    - name: Report Zeabur Deployment Status
      if: always() && steps.zeabur_deploy.outcome != 'skipped'
      run: |
        if [ "${{ steps.zeabur_deploy.outcome }}" == "success" ]; then
          echo "ğŸ‰ Zeabur deployment was successful!"
          echo "Your site should be available at your Zeabur domain shortly"
        else
          echo "âŒ Zeabur deployment failed. Please check the logs above for details."
          
          echo "Recommendations:"
          echo "1. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç»ˆç«¯è¾“å‡ºæ˜¾ç¤ºè¿æ¥è¶…æ—¶é—®é¢˜"
          echo "2. ä½¿ç”¨ zeabur project list å‘½ä»¤éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ"
          echo "3. è€ƒè™‘åœ¨ Zeabur æ§åˆ¶å°ä¸Šæ‰‹åŠ¨åˆ›å»ºé™æ€ç½‘ç«™æœåŠ¡"
        fi
